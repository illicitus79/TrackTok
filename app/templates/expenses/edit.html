{% extends "base.html" %}

{% block title %}Edit Expense - TrackTok{% endblock %}

{% block content %}
<div class="container" style="padding: 2rem 0; max-width: 720px;">
  <h1 style="margin: 0 0 1rem 0; font-size: 2rem;">Edit Expense</h1>
  <div class="card">
    <div class="card-body">
      <form method="POST" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label" for="project_id">Project</label>
            <select class="form-input" name="project_id" id="project_id">
              <option value="">Select a project</option>
              {% for project in projects %}
              <option value="{{ project.id }}" {% if expense.project_id == project.id %}selected{% endif %}>{{ project.name }}</option>
              {% endfor %}
            </select>
            <div class="form-hint">Selecting a project filters available source accounts.</div>
          </div>
          <div class="form-group">
            <label class="form-label" for="vendor">Vendor / Title</label>
            <input class="form-input" type="text" name="vendor" id="vendor" value="{{ expense.vendor or '' }}" />
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="note">Note</label>
          <textarea class="form-input" name="note" id="note" rows="2">{{ expense.note or '' }}</textarea>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label class="form-label" for="amount">Amount <span class="required">*</span></label>
            <input class="form-input" type="number" step="0.01" name="amount" id="amount" required value="{{ expense.amount }}" />
          </div>
          <div class="form-group">
            <label class="form-label" for="currency">Currency</label>
            <input class="form-input" type="text" name="currency" id="currency" value="{{ expense.currency }}" maxlength="3" readonly />
          </div>
          <div class="form-group">
            <label class="form-label" for="expense_date">Date <span class="required">*</span></label>
            <input class="form-input" type="text" inputmode="numeric" name="expense_date" id="expense_date" value="{{ format_date(expense.expense_date) }}" required placeholder="{{ date_format }}" />
            <div class="form-hint">Format: {{ date_format }}</div>
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label class="form-label" for="account_id">Source Account <span class="required">*</span></label>
            <select class="form-input" name="account_id" id="account_id" required>
              {% for account in accounts %}
              <option value="{{ account.id }}" {% if expense.account_id == account.id %}selected{% endif %}>{{ account.name }} ({{ account.account_type }})</option>
              {% endfor %}
            </select>
            <div class="form-hint">Accounts are filtered by the selected project.</div>
          </div>
          <div class="form-group">
            <label class="form-label" for="category_id">Category</label>
            <select class="form-input" name="category_id" id="category_id" {% if not expense.project_id %}disabled{% endif %}>
              <option value="">{% if expense.project_id %}Uncategorized{% else %}Select a project first{% endif %}</option>
              {% if expense.project_id %}
                {% for category in categories %}
                <option value="{{ category.id }}" {% if expense.category_id == category.id %}selected{% endif %}>{{ category.name }}</option>
                {% endfor %}
              {% endif %}
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" for="payment_method">Payment Method</label>
            <select class="form-input" name="payment_method" id="payment_method">
              {% for method in ["cash","credit_card","debit_card","bank_transfer","other"] %}
              <option value="{{ method }}" {% if expense.payment_method == method %}selected{% endif %}>{{ method.replace('_',' ')|title }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="attachments">Add Attachments</label>
          <input class="form-input" type="file" name="attachments" id="attachments" accept="image/*" multiple>
          <div class="form-hint">Upload additional images (png, jpg, jpeg, gif, webp). Max 5MB per image. Existing attachments stay intact.</div>
        </div>

        {% if expense.attachments %}
        <div class="card" style="margin-top: 0.75rem; background: rgba(255,255,255,0.03); border: 1px solid var(--border);">
          <div class="card-body" style="display: flex; flex-direction: column; gap: 0.35rem;">
            <div style="font-weight: 600;">Existing Attachments</div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.5rem;">
              {% for attachment in expense.attachments %}
              <div style="padding: 0.5rem; border: 1px solid var(--border); border-radius: 8px; text-align: center; background: rgba(255,255,255,0.02);">
                <div style="font-size: 0.9rem; margin-bottom: 0.35rem;">{{ attachment.filename or 'Image' }}</div>
                <img src="data:{{ attachment.content_type or 'image/png' }};base64,{{ attachment.data }}" alt="{{ attachment.filename or 'Attachment' }}" style="width: 100%; height: 100px; object-fit: cover; border-radius: 6px;" loading="lazy">
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
        {% endif %}

        {% set meta = expense.expense_metadata or {} %}
        {% if meta.get("edited") %}
        <div class="card" style="margin-top: 1rem; background: rgba(59,130,246,0.05); border: 1px solid var(--border);">
          <div class="card-body">
            <div style="font-weight: 600; color: var(--text);">Edit History</div>
            <div style="color: var(--text-muted); font-size: 0.9rem;">
              Last amount: {% if meta.get("last_amount") is not none %}${{ "%.2f"|format(meta.get("last_amount")|float) }}{% else %}N/A{% endif %}
              &middot; Last account: {{ meta.get("last_account_id") or "N/A" }}
              &middot; Edited by: {{ meta.get("last_updated_by_name") or meta.get("last_updated_by") or "Unknown" }}
              &middot; At: {{ meta.get("last_updated_at") or "Unknown" }}
            </div>
          </div>
        </div>
        {% endif %}

        <div style="display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 1rem;">
          <a class="btn btn-secondary" href="{{ url_for('web.expenses') }}">Cancel</a>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  const projectSelect = document.getElementById("project_id");
  const accountSelect = document.getElementById("account_id");
  const categorySelect = document.getElementById("category_id");
  const currencyInput = document.getElementById("currency");
  const tenantCurrency = "{{ tenant_currency }}";
  let accountMeta = {{ account_meta|tojson }};

  function setCurrencyForAccount(accountId) {
    const selected = accountMeta.find((a) => String(a.id) === String(accountId));
    currencyInput.value = selected && selected.currency ? selected.currency : tenantCurrency;
  }

  async function loadAccountsForProject(projectId) {
    if (!projectId) {
      accountSelect.innerHTML = '<option value=\"\">Select a project first</option>';
      accountSelect.disabled = true;
      currencyInput.value = tenantCurrency;
      return;
    }
    accountSelect.disabled = true;
    accountSelect.innerHTML = '<option>Loading...</option>';
    try {
      const res = await fetch(`/projects/${projectId}/allowed-accounts`, { credentials: "include" });
      if (!res.ok) throw new Error("Failed to load accounts");
      const accounts = await res.json();
      accountMeta = accounts;
      if (!accounts.length) {
        accountSelect.innerHTML = '<option value=\"\">No accounts allowed for this project</option>';
        return;
      }
      accountSelect.innerHTML = '<option value=\"\">Select account</option>';
      accounts.forEach((acc) => {
        const opt = document.createElement("option");
        opt.value = acc.id;
        opt.textContent = `${acc.name} (${acc.account_type})`;
        accountSelect.appendChild(opt);
      });
      accountSelect.disabled = false;
      // Reselect previous value if still present
      const current = "{{ expense.account_id }}";
      if (current) {
        accountSelect.value = current;
      }
      setCurrencyForAccount(accountSelect.value);
    } catch (e) {
      accountSelect.innerHTML = '<option value=\"\">Error loading accounts</option>';
      currencyInput.value = tenantCurrency;
    }
  }

  async function loadCategoriesForProject(projectId) {
    if (!projectId) {
      categorySelect.innerHTML = '<option value=\"\">Select a project first</option>';
      categorySelect.disabled = true;
      return;
    }
    categorySelect.disabled = true;
    categorySelect.innerHTML = '<option>Loading...</option>';
    try {
      const res = await fetch(`/projects/${projectId}/categories/json`, { credentials: "include" });
      if (!res.ok) throw new Error("Failed to load categories");
      const categories = await res.json();
      if (!categories.length) {
        categorySelect.innerHTML = '<option value=\"\">No categories yet</option>';
        categorySelect.disabled = false;
        return;
      }
      categorySelect.innerHTML = '<option value=\"\">Uncategorized</option>';
      categories.forEach((cat) => {
        const opt = document.createElement("option");
        opt.value = cat.id;
        opt.textContent = `${cat.name}${cat.is_active ? "" : " (inactive)"}`;
        categorySelect.appendChild(opt);
      });
      categorySelect.disabled = false;
      const current = "{{ expense.category_id or '' }}";
      if (current) {
        categorySelect.value = current;
      }
    } catch (e) {
      categorySelect.innerHTML = '<option value=\"\">Error loading categories</option>';
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    accountSelect.addEventListener("change", (e) => {
      setCurrencyForAccount(e.target.value);
    });
    if (projectSelect.value) {
      loadAccountsForProject(projectSelect.value);
      loadCategoriesForProject(projectSelect.value);
    } else {
      currencyInput.value = tenantCurrency;
    }
    projectSelect.addEventListener("change", (e) => {
      loadAccountsForProject(e.target.value);
      loadCategoriesForProject(e.target.value);
    });
  });
</script>
{% endblock %}
