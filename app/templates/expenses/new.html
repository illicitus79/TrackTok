{% extends "base.html" %}

{% block title %}Add Expense - TrackTok{% endblock %}

{% block content %}
<div class="container" style="padding: 2rem 0; max-width: 720px;">
  <h1 style="margin: 0 0 1rem 0; font-size: 2rem;">Add Expense</h1>
  <div class="card">
    <div class="card-body">
      <form method="POST" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label" for="project_id">Project</label>
            <select class="form-input" name="project_id" id="project_id">
              <option value="">Select a project</option>
              {% for project in projects %}
              <option value="{{ project.id }}" {% if initial_project_id == project.id %}selected{% endif %}>{{ project.name }}</option>
              {% endfor %}
            </select>
            <div class="form-hint">Select project to see available source accounts.</div>
          </div>
          <div class="form-group">
            <label class="form-label" for="vendor">Vendor / Title</label>
            <input class="form-input" type="text" name="vendor" id="vendor" placeholder="Acme Cloud" />
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="note">Note</label>
          <textarea class="form-input" name="note" id="note" rows="2" placeholder="Optional notes"></textarea>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label class="form-label" for="amount">Amount <span class="required">*</span></label>
            <input class="form-input" type="number" step="0.01" name="amount" id="amount" required />
          </div>
          <div class="form-group">
            <label class="form-label" for="currency">Currency</label>
            <input class="form-input" type="text" name="currency" id="currency" value="{{ tenant_currency }}" maxlength="3" readonly />
          </div>
          <div class="form-group">
            <label class="form-label" for="expense_date">Date <span class="required">*</span></label>
            <input class="form-input" type="text" inputmode="numeric" name="expense_date" id="expense_date" value="{{ today_display }}" required placeholder="{{ date_format }}" />
            <div class="form-hint">Format: {{ date_format }}</div>
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label class="form-label" for="account_id">Source Account <span class="required">*</span></label>
            <select class="form-input" name="account_id" id="account_id" required {% if not initial_project_id %}disabled{% endif %}>
              <option value="">{% if initial_project_id %}Select account{% else %}Select a project first{% endif %}</option>
              {% for account in accounts %}
              <option value="{{ account.id }}">{{ account.name }} ({{ account.account_type }})</option>
              {% endfor %}
            </select>
            <div class="form-hint">Accounts are filtered by the selected project.</div>
          </div>
          <div class="form-group">
            <label class="form-label" for="category_id">Category</label>
            <select class="form-input" name="category_id" id="category_id" {% if not initial_project_id %}disabled{% endif %}>
              <option value="">{% if initial_project_id %}Uncategorized{% else %}Select a project first{% endif %}</option>
              {% if initial_project_id %}
                {% for category in categories %}
                <option value="{{ category.id }}">{{ category.name }}</option>
                {% endfor %}
              {% endif %}
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" for="payment_method">Payment Method</label>
            <select class="form-input" name="payment_method" id="payment_method">
              <option value="cash">Cash</option>
              <option value="credit_card">Credit Card</option>
              <option value="debit_card">Debit Card</option>
              <option value="bank_transfer">Bank Transfer</option>
              <option value="other">Other</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="attachments">Attachments</label>
          <input class="form-input" type="file" name="attachments" id="attachments" accept="image/*" multiple>
          <div class="form-hint">Upload images (png, jpg, jpeg, gif, webp). Max 5MB per image.</div>
        </div>

        <div style="display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 1rem;">
          <a class="btn btn-secondary" href="{{ url_for('web.expenses') }}">Cancel</a>
          <button type="submit" class="btn btn-primary">Save Expense</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  const projectSelect = document.getElementById("project_id");
  const accountSelect = document.getElementById("account_id");
  const categorySelect = document.getElementById("category_id");
  const currencyInput = document.getElementById("currency");
  const tenantCurrency = "{{ tenant_currency }}";
  let accountMeta = {{ account_meta|tojson }};

  function setCurrencyForAccount(accountId) {
    const selected = accountMeta.find((a) => String(a.id) === String(accountId));
    currencyInput.value = selected && selected.currency ? selected.currency : tenantCurrency;
  }

  async function loadAccountsForProject(projectId) {
    if (!projectId) {
      accountSelect.innerHTML = '<option value="">Select a project first</option>';
      accountSelect.disabled = true;
      currencyInput.value = tenantCurrency;
      return;
    }
    accountSelect.disabled = true;
    accountSelect.innerHTML = '<option>Loading...</option>';
    try {
      const res = await fetch(`/projects/${projectId}/allowed-accounts`, { credentials: "include" });
      if (!res.ok) throw new Error("Failed to load accounts");
      const accounts = await res.json();
      accountMeta = accounts;
      if (!accounts.length) {
        accountSelect.innerHTML = '<option value="">No accounts allowed for this project</option>';
        return;
      }
      accountSelect.innerHTML = '<option value="">Select account</option>';
      accounts.forEach((acc) => {
        const opt = document.createElement("option");
        opt.value = acc.id;
        opt.textContent = `${acc.name} (${acc.account_type})`;
        accountSelect.appendChild(opt);
      });
      accountSelect.disabled = false;
    } catch (e) {
      accountSelect.innerHTML = '<option value="">Error loading accounts</option>';
      currencyInput.value = tenantCurrency;
    }
  }

  async function loadCategoriesForProject(projectId) {
    if (!projectId) {
      categorySelect.innerHTML = '<option value="">Select a project first</option>';
      categorySelect.disabled = true;
      return;
    }
    categorySelect.disabled = true;
    categorySelect.innerHTML = '<option>Loading...</option>';
    try {
      const res = await fetch(`/projects/${projectId}/categories/json`, { credentials: "include" });
      if (!res.ok) throw new Error("Failed to load categories");
      const categories = await res.json();
      if (!categories.length) {
        categorySelect.innerHTML = '<option value="">No categories yet</option>';
        categorySelect.disabled = false;
        return;
      }
      categorySelect.innerHTML = '<option value="">Uncategorized</option>';
      categories.forEach((cat) => {
        const opt = document.createElement("option");
        opt.value = cat.id;
        opt.textContent = `${cat.name}${cat.is_active ? "" : " (inactive)"}`;
        categorySelect.appendChild(opt);
      });
      categorySelect.disabled = false;
    } catch (e) {
      categorySelect.innerHTML = '<option value="">Error loading categories</option>';
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    // Update currency on account change
    accountSelect.addEventListener("change", (e) => {
      setCurrencyForAccount(e.target.value);
    });

    const onlyOneProject = projectSelect.options.length === 2 && !projectSelect.value;
    if (onlyOneProject) {
      projectSelect.selectedIndex = 1;
    }
    if (projectSelect.value) {
      loadAccountsForProject(projectSelect.value);
      loadCategoriesForProject(projectSelect.value);
    } else {
      accountSelect.disabled = true;
      categorySelect.disabled = true;
      currencyInput.value = tenantCurrency;
    }
    projectSelect.addEventListener("change", (e) => {
      loadAccountsForProject(e.target.value);
      loadCategoriesForProject(e.target.value);
    });
  });
</script>
{% endblock %}
