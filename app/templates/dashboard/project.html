{% extends "base.html" %} {% block title %}{{ project.name }} - Dashboard{%
endblock %} {% block content %}
<div class="dashboard-container">
  <header class="dashboard-header" aria-label="Project overview">
    <div class="header-content">
      <nav class="breadcrumb" aria-label="Breadcrumb">
        <a href="{{ url_for('web.projects') }}">Projects</a>
        <span aria-hidden="true">/</span>
        <span>{{ project.name }}</span>
      </nav>
      <h1 class="page-title">{{ project.name }}</h1>
      <p class="project-description">
        {{ project.description or 'No description' }}
      </p>
      <div class="project-meta">
        <span class="meta-item" aria-label="Project dates">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            aria-hidden="true"
          >
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
          {{ project.start_date.strftime('%b %d, %Y') if project.start_date else
          'Start date TBD' }} – {{ project.end_date.strftime('%b %d, %Y') if
          project.end_date else 'End date TBD' }}
        </span>
        <span class="meta-item" aria-label="Project status">
          <span class="badge badge-{{ project.status }}"
            >{{ project.status.capitalize() }}</span
          >
        </span>
      </div>
    </div>
    <div class="header-actions" role="group" aria-label="Primary actions">
      <button
        class="btn btn-secondary"
        onclick="window.location.href='{{ url_for('web.project_categories', project_id=project.id) }}'"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          aria-hidden="true"
        >
          <path d="M3 7h18"></path>
          <path d="M6 3h12"></path>
          <rect x="3" y="7" width="18" height="14" rx="2"></rect>
        </svg>
        Manage Categories
      </button>
      <button
        class="btn btn-secondary"
        onclick="window.location.href='{{ url_for('web.expense_new', project_id=project.id) }}'"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          aria-hidden="true"
        >
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Add Expense
      </button>
      <button class="btn btn-secondary" onclick="exportReport()">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          aria-hidden="true"
        >
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        Export
      </button>
    </div>
  </header>

  <section class="dashboard-hero" aria-label="Spending health">
    <div class="hero-content">
      <div class="eyebrow">Spending health</div>
      <h2 class="hero-title">How the project is tracking</h2>
      <p class="hero-subtitle">
        A quick pulse-check on pace, runway, and where money is going.
      </p>

      <div class="stat-footer stat-footer-tight">
        <div class="progress-bar" aria-label="Budget utilization">
          <div
            class="progress-fill"
            data-progress="utilization"
            style="width: {{ dashboard_data.budget_utilization }}%;"
          ></div>
        </div>
        <span class="stat-hint">
          <span data-stat="utilization">{{ "%.0f"|format(dashboard_data.budget_utilization) }}</span>% used
          {% if dashboard_data.insights and dashboard_data.insights.top_category_name %}
          • Top category: {{ dashboard_data.insights.top_category_name }}
          {% if dashboard_data.insights.top_category_share is not none %}
          ({{ "%.0f"|format(dashboard_data.insights.top_category_share) }}%)
          {% endif %}
          {% endif %}
        </span>
      </div>
    </div>

    <div class="hero-stats" aria-label="Key spend insights">
      <div class="stat-chip">
        <div class="chip-label">Spent (7 days)</div>
        <div class="chip-value" data-stat="spend_7d">
          {{ format_money(dashboard_data.insights.spend_7d) if dashboard_data.insights else format_money(0) }}
        </div>
        <div class="chip-meta">
          Avg/day: <span data-stat="avg_daily_7d">{{ format_money(dashboard_data.insights.avg_daily_7d) if dashboard_data.insights else format_money(0) }}</span>
        </div>
      </div>

      <div class="stat-chip">
        <div class="chip-label">This month (MTD)</div>
        <div class="chip-value" data-stat="spend_mtd">
          {{ format_money(dashboard_data.insights.spend_mtd) if dashboard_data.insights else format_money(0) }}
        </div>
        <div class="chip-meta">
          {% if dashboard_data.insights and dashboard_data.insights.mtd_change_pct is not none %}
            {{ "%.0f"|format(dashboard_data.insights.mtd_change_pct) }}% vs last month
          {% else %}
            Compared to last month
          {% endif %}
        </div>
      </div>

      <div class="stat-chip">
        <div class="chip-label">Runway</div>
        <div class="chip-value">
          {% if dashboard_data.insights and dashboard_data.insights.runway_days is not none %}
            {{ "%.0f"|format(dashboard_data.insights.runway_days) }}<span class="stat-unit">days</span>
          {% else %}
            —
          {% endif %}
        </div>
        <div class="chip-meta">At the 30-day average pace</div>
      </div>

      <div class="stat-chip">
        <div class="chip-label">Largest expense</div>
        <div class="chip-value">
          {% if dashboard_data.insights and dashboard_data.insights.biggest_expense %}
            {{ format_money(dashboard_data.insights.biggest_expense.amount) }}
          {% else %}
            —
          {% endif %}
        </div>
        <div class="chip-meta">
          {% if dashboard_data.insights and dashboard_data.insights.biggest_expense %}
            {{ dashboard_data.insights.biggest_expense.vendor }}
          {% else %}
            No expense data yet
          {% endif %}
        </div>
      </div>
    </div>
  </section>

  <div class="dashboard-grid">
    <div class="dashboard-main">
      <!-- Budget Overview Cards -->
      <div class="cards-grid">
        <div class="stat-card card-gradient-indigo">
          <div class="stat-card-header">
            <div class="stat-label">Total Budget</div>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <line x1="12" y1="1" x2="12" y2="23"></line>
              <path
                d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"
              ></path>
            </svg>
          </div>
          <div class="stat-value" data-stat="starting_budget">
            {{ format_money(dashboard_data.starting_budget) }}
          </div>
          <div class="stat-footer">
            <span class="stat-change positive"
              >Projected:
              <span data-stat="projected_estimate"
                >{{ format_money(dashboard_data.projected_estimate) }}</span
              ></span
            >
          </div>
        </div>

        <div class="stat-card card-gradient-emerald">
          <div class="stat-card-header">
            <div class="stat-label">Total Spent</div>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M3 3h18v18H3zM12 8v8m-4-4h8"></path>
            </svg>
          </div>
          <div class="stat-value" data-stat="total_spend">
            {{ format_money(dashboard_data.total_spend) }}
          </div>
          <div class="stat-footer">
            <div class="progress-bar">
              <div
                class="progress-fill"
                data-progress="utilization"
                style="width: {{ dashboard_data.budget_utilization }}%;"
              ></div>
            </div>
            <span class="stat-hint"
              ><span data-stat="utilization"
                >{{ "%.0f"|format(dashboard_data.budget_utilization) }}</span
              >% of budget</span
            >
          </div>
        </div>

        <div
          class="stat-card{% if dashboard_data.is_over_budget %} card-gradient-error{% elif dashboard_data.budget_utilization > 80 %} card-gradient-warning{% else %} card-gradient-emerald{% endif %}"
          data-card-status="remaining"
        >
          <div class="stat-card-header">
            <div class="stat-label">Remaining Budget</div>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
            </svg>
          </div>
          <div class="stat-value" data-stat="remaining_budget">
            {{ format_money(dashboard_data.remaining_budget) }}
          </div>
          <div class="stat-footer">
            <span class="stat-hint"
              ><span data-stat="days_remaining"
                >{{ dashboard_data.days_remaining }}</span
              >
              days remaining</span
            >
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-card-header">
            <div class="stat-label">Burn Rate</div>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <line x1="12" y1="20" x2="12" y2="10"></line>
              <line x1="18" y1="20" x2="18" y2="4"></line>
              <line x1="6" y1="20" x2="6" y2="16"></line>
            </svg>
          </div>
          <div class="stat-value" data-stat="burn_rate">
            {{ format_money(dashboard_data.burn_rate) }}<span class="stat-unit"
              >/day</span
            >
          </div>
          <div class="stat-footer">
            <span class="stat-hint">Daily average</span>
          </div>
        </div>
      </div>

      <!-- Charts Section -->
      <div class="charts-section">
        <!-- Row 1: Daily Trend & Category Breakdown -->
        <div class="charts-row">
          <div class="chart-card">
            <div class="chart-header">
              <h3>Daily Spend (Last 30 Days)</h3>
            </div>
            <div class="chart-container">
              <canvas id="dailyChart"></canvas>
            </div>
            <div class="chart-footer">
              <span class="chart-hint">Spot spikes and spend momentum</span>
            </div>
          </div>

          <div class="chart-card">
            <div class="chart-header">
              <h3>Category Breakdown</h3>
              <div class="chart-legend" id="categoryLegend"></div>
            </div>
            <div class="chart-container">
              <canvas id="categoryChart"></canvas>
            </div>
            <div class="chart-footer">
              <span class="chart-hint">Total expenses by category</span>
            </div>
          </div>

        </div>

        <!-- Row 2: Monthly Spend & Top Vendors -->
        <div class="charts-row">
          <div class="chart-card">
            <div class="chart-header">
              <h3>Monthly Spend by Account</h3>
              <div class="chart-controls">
                <select id="monthFilter" class="chart-select">
                  <option value="6">Last 6 months</option>
                  <option value="12">Last 12 months</option>
                  <option value="all">All time</option>
                </select>
              </div>
            </div>
            <div class="chart-container">
              <canvas id="monthlyChart"></canvas>
            </div>
            <div class="chart-footer">
              <span class="chart-hint">Stacked by account</span>
            </div>
          </div>

          <div class="chart-card">
            <div class="chart-header">
              <h3>Top Vendors</h3>
            </div>
            <div class="chart-container">
              <canvas id="vendorChart"></canvas>
            </div>
            <div class="chart-footer">
              <span class="chart-hint">Where the spend is concentrated</span>
            </div>
          </div>
        </div>

        <!-- Row 3: Forecast -->
        <div class="charts-row">
          <div class="chart-card chart-wide">
            <div class="chart-header">
              <h3>Forecast vs Actual</h3>
              <div class="forecast-badge" data-forecast-status="on-track">
                <span class="badge badge-success">On Track</span>
              </div>
            </div>
            <div class="chart-container">
              <canvas id="forecastChart"></canvas>
            </div>
            <div class="chart-footer">
              <div class="forecast-stats">
                <div class="forecast-stat">
                  <span class="label">Projected Total:</span>
                  <span class="value" data-stat="projected_total"
                    >{{ format_money(dashboard_data.forecast.projected_total)
                    }}</span
                  >
                </div>
                <div class="forecast-stat">
                  <span class="label">Confidence:</span>
                  <span class="value" data-stat="confidence"
                    >{{ dashboard_data.forecast.confidence }}%</span
                  >
                </div>
                <div class="forecast-stat">
                  <span class="label">Variance:</span>
                  <span class="value" data-stat="variance"
                    >{{ format_money(dashboard_data.forecast.variance) }}</span
                  >
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <aside class="dashboard-side" aria-label="Secondary insights">
      <!-- Account Balances Sparklines -->
      <div class="chart-card">
        <div class="chart-header">
          <h3>Account Balances</h3>
        </div>
        <div class="accounts-list" id="accountsList">
          <!-- Populated by JavaScript -->
        </div>
      </div>

      <div class="chart-card">
        <div class="chart-header">
          <h3>Recent Expenses</h3>
        </div>
        <div class="recent-expenses">
          {% if dashboard_data.recent_expenses %}
            {% for e in dashboard_data.recent_expenses %}
              <div class="recent-expense">
                <div class="recent-main">
                  <div class="recent-vendor">{{ e.vendor }}</div>
                  <div class="recent-meta">
                    <span>{{ e.category }}</span>
                    <span aria-hidden="true">•</span>
                    <span>{{ e.account }}</span>
                    {% if e.date %}
                      <span aria-hidden="true">•</span>
                      <span>{{ e.date }}</span>
                    {% endif %}
                  </div>
                </div>
                <div class="recent-amount">{{ format_money(e.amount) }}</div>
              </div>
            {% endfor %}
          {% else %}
            <div class="empty-state empty-state-compact">
              <p>No expenses yet for this project.</p>
            </div>
          {% endif %}
        </div>
      </div>
    </aside>
  </div>
</div>
{% endblock %} {% block extra_scripts %}
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
<script>
  // Initialize dashboard with server-side data
  const projectId = {{ project.id|tojson }};
  const serverData = {{ dashboard_data|tojson }};
  const dashboardApp = new DashboardApp(projectId, serverData);

  // Export report function
  async function exportReport() {
      const format = await showExportDialog();
      if (format) {
          window.location.href = `/api/v1/reports/export.${format}?project_id=${projectId}`;
      }
  }

  function showExportDialog() {
      return new Promise((resolve) => {
          const choice = confirm('Export as CSV? (OK = CSV, Cancel = XLSX)');
          resolve(choice ? 'csv' : 'xlsx');
      });
  }
</script>
{% endblock %}
