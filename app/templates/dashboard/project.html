{% extends "base.html" %}

{% block title %}{{ project.name }} - Dashboard{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Project Header -->
    <div class="dashboard-header">
        <div class="header-content">
            <div class="breadcrumb">
                <a href="{{ url_for('web.projects') }}">Projects</a>
                <span>/</span>
                <span>{{ project.name }}</span>
            </div>
            <h1>{{ project.name }}</h1>
            <p class="project-description">{{ project.description or 'No description' }}</p>
            
            <div class="project-meta">
                <span class="meta-item">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    {{ project.start_date.strftime('%b %d, %Y') }} - {{ project.end_date.strftime('%b %d, %Y') }}
                </span>
                <span class="meta-item">
                    <span class="badge badge-{{ project.status }}">{{ project.status.capitalize() }}</span>
                </span>
            </div>
        </div>
        
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="window.location.href='{{ url_for('web.project_expenses', project_id=project.id) }}'">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Add Expense
            </button>
            <button class="btn btn-secondary" onclick="exportReport()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Export
            </button>
        </div>
    </div>

    <!-- Budget Overview Cards -->
    <div class="cards-grid">
        <div class="stat-card card-gradient-indigo">
            <div class="stat-card-header">
                <div class="stat-label">Total Budget</div>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="1" x2="12" y2="23"></line>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                </svg>
            </div>
            <div class="stat-value" data-stat="starting_budget">$0.00</div>
            <div class="stat-footer">
                <span class="stat-change positive">Projected: <span data-stat="projected_estimate">$0.00</span></span>
            </div>
        </div>
        
        <div class="stat-card card-gradient-emerald">
            <div class="stat-card-header">
                <div class="stat-label">Total Spent</div>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 3h18v18H3zM12 8v8m-4-4h8"></path>
                </svg>
            </div>
            <div class="stat-value" data-stat="total_spend">$0.00</div>
            <div class="stat-footer">
                <div class="progress-bar">
                    <div class="progress-fill" data-progress="utilization" style="width: 0%"></div>
                </div>
                <span class="stat-hint"><span data-stat="utilization">0</span>% of budget</span>
            </div>
        </div>
        
        <div class="stat-card" data-card-status="remaining">
            <div class="stat-card-header">
                <div class="stat-label">Remaining Budget</div>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                </svg>
            </div>
            <div class="stat-value" data-stat="remaining_budget">$0.00</div>
            <div class="stat-footer">
                <span class="stat-hint"><span data-stat="days_remaining">0</span> days remaining</span>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-label">Burn Rate</div>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="20" x2="12" y2="10"></line>
                    <line x1="18" y1="20" x2="18" y2="4"></line>
                    <line x1="6" y1="20" x2="6" y2="16"></line>
                </svg>
            </div>
            <div class="stat-value" data-stat="burn_rate">$0.00<span class="stat-unit">/day</span></div>
            <div class="stat-footer">
                <span class="stat-hint">Daily average</span>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
        <!-- Row 1: Category Breakdown & Monthly Trend -->
        <div class="charts-row">
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Category Breakdown</h3>
                    <div class="chart-legend" id="categoryLegend"></div>
                </div>
                <div class="chart-container">
                    <canvas id="categoryChart"></canvas>
                </div>
                <div class="chart-footer">
                    <span class="chart-hint">Total expenses by category</span>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Monthly Spend by Account</h3>
                    <div class="chart-controls">
                        <select id="monthFilter" class="chart-select">
                            <option value="6">Last 6 months</option>
                            <option value="12">Last 12 months</option>
                            <option value="all">All time</option>
                        </select>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="monthlyChart"></canvas>
                </div>
                <div class="chart-footer">
                    <span class="chart-hint">Stacked by account</span>
                </div>
            </div>
        </div>
        
        <!-- Row 2: Forecast & Account Balances -->
        <div class="charts-row">
            <div class="chart-card chart-wide">
                <div class="chart-header">
                    <h3>Forecast vs Actual</h3>
                    <div class="forecast-badge" data-forecast-status="on-track">
                        <span class="badge badge-success">On Track</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="forecastChart"></canvas>
                </div>
                <div class="chart-footer">
                    <div class="forecast-stats">
                        <div class="forecast-stat">
                            <span class="label">Projected Total:</span>
                            <span class="value" data-stat="projected_total">$0.00</span>
                        </div>
                        <div class="forecast-stat">
                            <span class="label">Confidence:</span>
                            <span class="value" data-stat="confidence">0%</span>
                        </div>
                        <div class="forecast-stat">
                            <span class="label">Variance:</span>
                            <span class="value" data-stat="variance">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Account Balances Sparklines -->
        <div class="chart-card">
            <div class="chart-header">
                <h3>Account Balances</h3>
            </div>
            <div class="accounts-list" id="accountsList">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
<script>
// Initialize dashboard with project ID
const projectId = {{ project.id }};
const dashboardApp = new DashboardApp(projectId);

// Export report function
async function exportReport() {
    const format = await showExportDialog();
    if (format) {
        window.location.href = `/api/v1/reports/export.${format}?project_id=${projectId}`;
    }
}

function showExportDialog() {
    return new Promise((resolve) => {
        const choice = confirm('Export as CSV? (OK = CSV, Cancel = XLSX)');
        resolve(choice ? 'csv' : 'xlsx');
    });
}
</script>
{% endblock %}
